# This workflow deploys Salesforce metadata to a scratch org when code is pushed to the 'qa' branch.
# It uses the modern 'sf' CLI syntax and the official Salesforce GitHub Actions.

name: Deploy to Scratch Org (QA)

on:
  push:
    branches:
      - qa  # Trigger only on the QA branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. Check out the repository's code so the workflow can access it.
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Install the Salesforce CLI using the official action.
    # This replaces the outdated 'amtrack/sfdx-action'.
    - name: Install Salesforce CLI
      uses: sfdx-actions/setup-sfdx@v1

    # 3. Authenticate to the Dev Hub using a JWT key.
    # This is a secure way to log in without storing passwords.
    - name: Authenticate Dev Hub via JWT
      run: |
        # The server key is stored as a GitHub Secret and written to a temporary file.
        echo "${{ secrets.SF_SERVER_KEY }}" > server.key

        # Authenticate using the 'sf' command.
        sf org login jwt \
          --client-id "${{ secrets.SF_CLIENT_ID }}" \
          --jwt-key-file server.key \
          --username "${{ secrets.SF_USERNAME }}" \
          --instance-url "${{ secrets.SF_INSTANCE_URL }}" \
          --set-default-dev-hub

        # Clean up the key file after use.
        rm server.key

    # 4. Create a new scratch org for testing.
    - name: Create Scratch Org
      run: |
        sf org create scratch \
          --definition-file config/project-scratch-def.json \
          --alias QA_Scratch \
          --set-default \
          --duration-days 7

    # 5. Deploy the source code from the repository to the scratch org.
    - name: Deploy to Scratch Org
      run: |
        sf project deploy start

    # 6. (Optional) This step generates a login link for manual access if needed.
    # You can comment this out if you don't need it.
    - name: Open Scratch Org (Generate Login Link)
      run: |
        sf org open --url-only

    # 7. (Optional) Clean up by deleting the scratch org after the job is done.
    # The 'if: always()' condition ensures this step runs even if a previous step fails.
    - name: Delete Scratch Org
      if: always()
      run: |
        sf org delete scratch --no-prompt --target-org QA_Scratch

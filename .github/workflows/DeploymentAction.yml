name: Deploy to Scratch Org (QA)

on:
  push:
    branches:
      - qa   # Trigger only on QA branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
      SF_USERNAME: ${{ secrets.SF_USERNAME }}
      SF_SERVER_KEY: ${{ secrets.SF_SERVER_KEY }}
      SF_INSTANCE_URL: ${{ secrets.SF_INSTANCE_URL }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Salesforce CLI
      uses: forcedotcom/sfdx-action@v1

    - name: Authenticate Dev Hub via JWT
      shell: bash
      run: |
        # Write private key safely
        printf "%s" "$SF_SERVER_KEY" > server.key

        # Authenticate
        sfdx force:auth:jwt:grant \
          --clientid "$SF_CLIENT_ID" \
          --jwtkeyfile server.key \
          --username "$SF_USERNAME" \
          --instanceurl "$SF_INSTANCE_URL"

        # Verify login
        sfdx force:org:display -u "$SF_USERNAME"

    - name: Create Scratch Org
      run: |
        sfdx force:org:create -f config/project-scratch-def.json -a QA_Scratch -s -d 7
        sfdx force:org:display -u QA_Scratch

    - name: Deploy to Scratch Org
      run: |
        sfdx force:source:push -u QA_Scratch

    - name: Open Scratch Org (Optional)
      run: |
        sfdx force:org:open -u QA_Scratch

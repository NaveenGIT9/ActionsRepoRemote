name: Salesforce DX QA Deployment (SFDX URL)

on:
  push:
    branches:
      - main  # Trigger workflow on pushes to main branch

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. Checkout source
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Node + NPM + Salesforce CLI
      - name: Install Salesforce CLI (via npm)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm
          # Use the new package name @salesforce/cli for consistency
          npm install --global @salesforce/cli 
          echo "$(npm bin -g)" >> $GITHUB_PATH
          sfdx --version

      # --- CHANGES START HERE ---

      # 3. Store SFDX Auth URL Secret and Authenticate to Dev Hub
      - name: Authenticate to Dev Hub (SFDX URL)
        env:
          # This secret holds the full sfdxAuthUrl value
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }} 
        run: |
          # Write the SFDX URL into a file
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt
          
          # Authenticate using the file and set an alias (DevHub)
          sfdx auth:sfdxurl:store \
            --sfdx-url-file sfdx-auth-url.txt \
            --setalias DevHub \
            --setdefaultdevhubusername 
            
          # Clean up the file 
          rm sfdx-auth-url.txt
          
          echo "Auth success. Listing orgs:"
          sfdx org list

      # --- CHANGES END HERE ---

      # 4. Create Scratch Org
      - name: Create Scratch Org
        run: |
          # -a QA_Scratch is the new alias
          sfdx org create scratch -f config/project-scratch-def.json -a QA_Scratch -s -d 7
          sfdx org display -o QA_Scratch

      # 5. Push source to scratch org
      - name: Push Source
        run: |
          sfdx project deploy start -o QA_Scratch --source-dir force-app

      # 6. Run Apex Tests
      - name: Run Apex Tests
        run: |
          sfdx apex run test -o QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -o QA_Scratch --output-dir test-results || true

      # 7. Delete Scratch Org
      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx org delete scratch -o QA_Scratch -p || true

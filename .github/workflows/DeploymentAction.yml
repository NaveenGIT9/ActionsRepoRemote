name: Salesforce DX QA Deployment (SFDX URL)
on:
  push:
    branches:
      - main
jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Install Salesforce CLI (via npm) + jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm jq
          npm install --global @salesforce/cli
          echo "$(npm bin -g)" >> $GITHUB_PATH
          # Print both CLIs to help debugging
          echo "sfdx version:"
          sfdx --version || true
          echo "sf version:"
          sf --version || true
          jq --version || true
      - name: Authenticate to Dev Hub (SFDX URL)
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          set -euo pipefail
          echo "Writing SFDX auth url to file..."
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt
          echo "Storing auth and setting alias 'DevHub'..."
          # Use auth:sfdxurl:store; both sf and sfdx should support this plugin command
          sfdx auth:sfdxurl:store --sfdxurlfile sfdx-auth-url.txt --setalias DevHub --setdefaultdevhubusername
          rm sfdx-auth-url.txt
          echo "Auth step completed. Listing authenticated orgs:"
          sfdx org list --verbose || true
          echo "Config list (global/local):"
          sfdx config:list --local --global || true
      - name: Create Scratch Org (safe)
        shell: bash
        env:
          SNAPSHOT: ${{ secrets.SNAPSHOT_NAME }}
        run: |
          set -euo pipefail
          echo "---- Validate project-scratch-def.json ----"
          if command -v jq >/dev/null 2>&1; then
            jq . config/project-scratch-def.json || { echo 'Invalid JSON'; cat config/project-scratch-def.json; exit 1; }
          else
            cat config/project-scratch-def.json
            echo "Note: jq not found; visually inspect JSON above."
          fi
          echo "Setting target-dev-hub=DevHub (idempotent)"
          # prefer modern config name
          sfdx config:set target-dev-hub=DevHub --global || true
          # Build args - FIXED: Only add --snapshot if SNAPSHOT has a value
          ARGS="-f config/project-scratch-def.json -a QA_Scratch -s -d 7 --target-dev-hub DevHub"
          if [ -n "${SNAPSHOT:-}" ] && [ "${SNAPSHOT}" != "" ]; then
            echo "Snapshot provided. Will attempt to use snapshot."
            echo "Listing snapshots on DevHub (for troubleshooting)..."
            sfdx force:org:snapshot:list -v DevHub || echo "Snapshot list command failed or no snapshots present."
            ARGS="$ARGS --snapshot ${SNAPSHOT}"
          else
            echo "No snapshot provided; creating scratch org from project-scratch-def.json only."
          fi
          echo "Running: sf org create scratch $ARGS"
          set -x
          # Use the modern sf CLI command that works with the installed @salesforce/cli
          sf org create scratch $ARGS
          set +x
          echo "Display org:"
          sf org display -o QA_Scratch || true
      - name: Push Source
        run: |
          # push using the sf/sfdx commands you prefer; using sfdx project deploy start if available
          sfdx project deploy start -o QA_Scratch --source-dir force-app
      - name: Run Apex Tests
        run: |
          sfdx apex run test -u QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -u QA_Scratch --output-dir test-results || true
      - name: Delete Scratch Org
        if: always()
        run: |
          sf org delete scratch -o QA_Scratch -p || true

name: Deploy to QA

on:
  push:
    branches:
      - qa   # Trigger only on QA branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repo
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          mkdir sfdx
          tar xJf sfdx-linux-amd64.tar.xz -C sfdx --strip-components 1
          ./sfdx/install
          sfdx --version
          sfdx plugins --core

      # Step 3: Authenticate to Dev Hub using JWT
      - name: Authenticate to Dev Hub
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_SERVER_KEY: ${{ secrets.SF_SERVER_KEY }}
          SF_INSTANCE_URL: ${{ secrets.SF_INSTANCE_URL }}
        run: |
          echo "$SF_SERVER_KEY" > server.key
          sfdx force:auth:jwt:grant --clientid $SF_CLIENT_ID --jwtkeyfile server.key --username $SF_USERNAME --instanceurl $SF_INSTANCE_URL
          sfdx force:org:display -u $SF_USERNAME

      # Step 4: Create Scratch Org (optional, can skip if using a persistent org)
      - name: Create Scratch Org
        env:
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          sfdx force:org:create -s -f config/project-scratch-def.json -a QA_ScratchOrg -v $SF_USERNAME
          sfdx force:org:display -u QA_ScratchOrg

      # Step 5: Deploy Source to Scratch Org
      - name: Deploy Source
        run: |
          sfdx force:source:deploy -p force-app/main/default -u QA_ScratchOrg --checkonly --testlevel RunLocalTests

      # Step 6: Run Tests (optional, can remove if already in deploy)
      - name: Run Apex Tests
        run: |
          sfdx force:apex:test:run -u QA_ScratchOrg --resultformat human --wait 10

name: Salesforce DX QA Deployment (SFDX URL)

on:
  push:
    branches:
      - main  # Trigger workflow on pushes to main branch

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:

      # 1. Checkout source
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Node + NPM + Salesforce CLI
      - name: Install Salesforce CLI (via npm)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm
          npm install --global @salesforce/cli
          echo "$(npm bin -g)" >> $GITHUB_PATH
          sfdx --version

      # 3. Authenticate to Dev Hub (SFDX URL)
      - name: Authenticate to Dev Hub (SFDX URL)
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt

          sfdx auth:sfdxurl:store \
            --sfdx-url-file sfdx-auth-url.txt \
            --setalias DevHub \
            --setdefaultdevhubusername

          rm sfdx-auth-url.txt
          echo "Auth success. Listing orgs:"
          sfdx org list

      # 4. Create Scratch Org (safe + debug)
      - name: Create Scratch Org (safe)
        shell: bash
        env:
          SNAPSHOT: ${{ secrets.SNAPSHOT_NAME || '' }}  # optional; may be empty
        run: |
          set -euo pipefail

          echo "---- Debug: environment ----"
          echo "SNAPSHOT (masked): ${SNAPSHOT:+<set>}"
          env | sed -E 's/(PASSWORD|TOKEN|KEY|SECRET|SFDX_AUTH_URL)=.*/\1=<masked>/g' | sort

          echo "---- Validate project-scratch-def.json ----"
          if command -v jq >/dev/null 2>&1; then
            jq . config/project-scratch-def.json || { echo 'Invalid JSON'; cat config/project-scratch-def.json; exit 1; }
          else
            cat config/project-scratch-def.json
            echo "Note: jq not found; visually inspect JSON above."
          fi

          echo "---- Decide args ----"
          ARGS="-f config/project-scratch-def.json -a QA_Scratch -s -d 7"

          if [ -n "$SNAPSHOT" ]; then
            echo "Using snapshot: (masked)"
            ARGS="$ARGS --snapshot $SNAPSHOT"
          else
            echo "No snapshot provided; not passing --snapshot flag."
          fi

          echo "Running: sfdx org create scratch $ARGS"
          set -x
          sfdx org create scratch $ARGS
          set +x

          echo "Display org:"
          sfdx org display -o QA_Scratch || true

      # 5. Push source to scratch org
      - name: Push Source
        run: |
          sfdx project deploy start -o QA_Scratch --source-dir force-app

      # 6. Run Apex Tests
      - name: Run Apex Tests
        run: |
          sfdx apex run test -o QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -o QA_Scratch --output-dir test-results || true

      # 7. Delete Scratch Org
      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx org delete scratch -o QA_Scratch -p || true

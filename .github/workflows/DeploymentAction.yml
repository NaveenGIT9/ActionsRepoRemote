name: Salesforce DX QA Deployment

on:
  push:
    branches:
      - main   # Trigger workflow on pushes to main branchs

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. Checkout source
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Node + NPM + Salesforce CLI
      - name: Install Salesforce CLI (via npm)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm
          npm install --global @salesforce/cli
          echo "$(npm bin -g)" >> $GITHUB_PATH
          sfdx --version

      # 3. Decode private key from base64 secret
      - name: Write private key from b64 secret
        env:
          SF_SERVER_KEY_B64: ${{ secrets.SF_SERVER_KEY_B64 }}
        run: |
          echo "$SF_SERVER_KEY_B64" | base64 --decode > server.key
          chmod 600 server.key
          echo "Key loaded. Showing header:"
          head -n 3 server.key || true

      # 4. Authenticate to Dev Hub using JWT
      - name: Authenticate to Dev Hub (JWT)
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_USERNAME_HUB: ${{ secrets.SF_USERNAME_HUB }}
          SF_INSTANCE_URL: ${{ secrets.SF_INSTANCE_URL }}
        run: |
          sfdx auth:jwt:grant \
            --clientid "$SF_CLIENT_ID" \
            --jwtkeyfile server.key \
            --username "$SF_USERNAME_HUB" \
            --instanceurl "$SF_INSTANCE_URL"

          echo "Auth success. Listing orgs:"
          sfdx org list

      # 5. Create Scratch Org
      - name: Create Scratch Org
        run: |
          sfdx org create scratch -f config/project-scratch-def.json -a QA_Scratch -s -d 7
          sfdx org display -o QA_Scratch

      # 6. Push source to scratch org
      - name: Push Source
        run: |
          sfdx project deploy start -o QA_Scratch --source-dir force-app

      # 7. Run Apex Tests
      - name: Run Apex Tests
        run: |
          sfdx apex run test -o QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -o QA_Scratch --output-dir test-results || true

      # 8. Delete Scratch Org
      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx org delete scratch -o QA_Scratch -p || true

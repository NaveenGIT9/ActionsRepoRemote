name: Salesforce DX QA Deployment (SFDX URL)

on:
  push:
    branches:
      - main

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI (via npm)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm
          npm install --global @salesforce/cli
          echo "$(npm bin -g)" >> $GITHUB_PATH
          sfdx --version

      - name: Authenticate to Dev Hub (SFDX URL)
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          set -euo pipefail

          echo "Writing SFDX auth url to file..."
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt

          echo "Storing auth and setting alias 'DevHub'..."
          # store and explicitly set default dev hub username
          sfdx auth:sfdxurl:store \
            --sfdx-url-file sfdx-auth-url.txt \
            --setalias DevHub \
            --setdefaultdevhubusername

          rm sfdx-auth-url.txt

          echo "Auth step completed. Listing authenticated orgs:"
          sfdx org list --verbose || true

          echo "Ensure defaultdevhubusername is set:"
          sfdx config:list || true

      - name: Create Scratch Org (safe)
        shell: bash
        env:
          SNAPSHOT: ${{ secrets.SNAPSHOT_NAME || '' }}
        run: |
          set -euo pipefail

          echo "---- Validate project-scratch-def.json ----"
          if command -v jq >/dev/null 2>&1; then
            jq . config/project-scratch-def.json || { echo 'Invalid JSON'; cat config/project-scratch-def.json; exit 1; }
          else
            cat config/project-scratch-def.json
            echo "Note: jq not found; visually inspect JSON above."
          fi

          # Defensive: ensure DevHub alias is set as default (idempotent)
          echo "Setting defaultdevhubusername=DevHub (idempotent)"
          sfdx config:set defaultdevhubusername=DevHub

          # Decide args and guard snapshot
          ARGS="-f config/project-scratch-def.json -a QA_Scratch -s -d 7"
          if [ -n "$SNAPSHOT" ]; then
            echo "Using snapshot from secrets (masked)"
            ARGS="$ARGS --snapshot $SNAPSHOT"
          else
            echo "No snapshot provided; not passing --snapshot flag."
          fi

          echo "Running: sfdx org create scratch $ARGS -v DevHub"
          set -x
          # pass -v DevHub explicitly to be extra-safe
          sfdx org create scratch $ARGS -v DevHub
          set +x

          echo "Display org:"
          sfdx org display -o QA_Scratch || true

      - name: Push Source
        run: |
          sfdx project deploy start -o QA_Scratch --source-dir force-app

      - name: Run Apex Tests
        run: |
          sfdx apex run test -o QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -o QA_Scratch --output-dir test-results || true

      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx org delete scratch -o QA_Scratch -p || true

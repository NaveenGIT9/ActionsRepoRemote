name: Salesforce DX QA Deployment

on:
  push:
    branches:
      - qa   # Trigger only on pushes to qa branch

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          tar xJf sfdx-linux-amd64.tar.xz
          ./sfdx/install

      # 3. Authenticate to Dev Hub using JWT
      - name: Authenticate to Dev Hub
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_SERVER_KEY: ${{ secrets.SF_SERVER_KEY }}
          SF_USERNAME_HUB: ${{ secrets.SF_USERNAME_HUB }}
          SF_INSTANCE_URL: ${{ secrets.SF_INSTANCE_URL }}
        run: |
          # Write private key to a temporary file
          echo "$SF_SERVER_KEY" > server.key
          
          # Authenticate using JWT
          sfdx auth:jwt:grant \
            --clientid $SF_CLIENT_ID \
            --jwtkeyfile server.key \
            --username $SF_USERNAME_HUB \
            --instanceurl $SF_INSTANCE_URL

      # 4. Create Scratch Org
      - name: Create Scratch Org
        run: |
          sfdx force:org:create -f config/project-scratch-def.json -a QA_Scratch -s -d 7
          sfdx force:org:display -u QA_Scratch

      # 5. Push source to Scratch Org
      - name: Deploy Source to Scratch Org
        run: |
          sfdx force:source:push -u QA_Scratch

      # 6. Run Apex Tests
      - name: Run Apex Tests
        run: |
          sfdx force:apex:test:run -u QA_Scratch --wait 10 --resultformat human

      # 7. Delete Scratch Org
      - name: Delete Scratch Org
        run: |
          sfdx force:org:delete -u QA_Scratch -p

name: Salesforce DX QA Deployment (SFDX URL)

on:
  push:
    branches:
      - main

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI (via npm) + jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm jq
          npm install --global @salesforce/cli
          echo "$(npm bin -g)" >> $GITHUB_PATH
          sfdx --version
          jq --version

      - name: Authenticate to Dev Hub (SFDX URL)
        env:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
        run: |
          set -euo pipefail

          echo "Writing SFDX auth url to file..."
          echo "$SFDX_AUTH_URL" > sfdx-auth-url.txt

          echo "Storing auth and setting alias 'DevHub'..."
          # use canonical flag names
          sfdx auth:sfdxurl:store --sfdxurlfile sfdx-auth-url.txt --setalias DevHub --setdefaultdevhubusername

          rm sfdx-auth-url.txt

          echo "Auth step completed. Listing authenticated orgs:"
          sfdx org list --verbose || true

          echo "Ensure defaultdevhubusername is set:"
          sfdx config:list --local --global || true

      - name: Create Scratch Org (safe)
        shell: bash
        env:
          # use canonical expression; if secret missing this becomes empty string
          SNAPSHOT: ${{ secrets.SNAPSHOT_NAME }}
        run: |
          set -euo pipefail

          echo "---- Validate project-scratch-def.json ----"
          if command -v jq >/dev/null 2>&1; then
            jq . config/project-scratch-def.json || { echo 'Invalid JSON'; cat config/project-scratch-def.json; exit 1; }
          else
            cat config/project-scratch-def.json
            echo "Note: jq not found; visually inspect JSON above."
          fi

          echo "Setting defaultdevhubusername=DevHub (idempotent)"
          sfdx config:set defaultdevhubusername=DevHub --global || true

          # Prepare args and conditionally add --snapshot if present
          ARGS="-f config/project-scratch-def.json -a QA_Scratch -s -d 7"
          if [ -n "${SNAPSHOT:-}" ]; then
            echo "Snapshot provided (masked). Will attempt to use snapshot: ${SNAPSHOT}"
            # verify snapshot exists in DevHub (best-effort)
            echo "Listing snapshots on DevHub (for troubleshooting)..."
            sfdx force:org:snapshot:list -v DevHub || echo "Snapshot list command failed or no snapshots present."
            ARGS="$ARGS --snapshot $SNAPSHOT"
          else
            echo "No snapshot provided; creating scratch org from project-scratch-def.json only."
          fi

          echo "Running: sfdx force:org:create $ARGS --targetdevhubusername DevHub"
          set -x
          sfdx force:org:create $ARGS --targetdevhubusername DevHub
          set +x

          echo "Display org:"
          sfdx org display -u QA_Scratch || true

      - name: Push Source
        run: |
          sfdx project deploy start -o QA_Scratch --source-dir force-app

      - name: Run Apex Tests
        run: |
          sfdx apex run test -u QA_Scratch --wait 30 --result-format human || true
          sfdx apex get test-report -u QA_Scratch --output-dir test-results || true

      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx org delete scratch -u QA_Scratch -p || true

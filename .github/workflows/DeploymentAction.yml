name: Salesforce DX QA Deployment

on:
  push:
    branches:
      - qa   # Trigger only on pushes to qa branch

jobs:
  deploy-to-scratch-org:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Node.js (required for npm)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. Install Salesforce CLI
      - name: Install Salesforce CLI
        run: npm install sfdx-cli --global

      # 4. Authenticate to Dev Hub using JWT
      - name: Authenticate to Dev Hub
        env:
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_SERVER_KEY: ${{ secrets.SF_SERVER_KEY }}
          SF_USERNAME_HUB: ${{ secrets.SF_USERNAME_HUB }}
          SF_INSTANCE_URL: ${{ secrets.SF_INSTANCE_URL }}
        run: |
          echo "$SF_SERVER_KEY" > server.key
          sfdx auth:jwt:grant \
            --clientid $SF_CLIENT_ID \
            --jwtkeyfile server.key \
            --username $SF_USERNAME_HUB \
            --instanceurl $SF_INSTANCE_URL
          sfdx force:org:display -u $SF_USERNAME_HUB

      # 5. Create Scratch Org
      - name: Create Scratch Org
        run: |
          sfdx force:org:create -f config/project-scratch-def.json -a QA_Scratch -s -d 7
          sfdx force:org:display -u QA_Scratch

      # 6. Push source to Scratch Org
      - name: Deploy Source to Scratch Org
        run: |
          sfdx force:source:push -u QA_Scratch

      # 7. Run Apex Tests
      - name: Run Apex Tests
        run: |
          sfdx force:apex:test:run -u QA_Scratch --wait 10 --resultformat human

      # 8. Delete Scratch Org
      - name: Delete Scratch Org
        run: |
          sfdx force:org:delete -u QA_Scratch -p
